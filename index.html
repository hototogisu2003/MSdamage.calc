<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ダメージ計算ツール</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --muted:#475569;    /* slate-600 */
      --text:#0f172a;     /* slate-900 */
      --accent:#0369a1;   /* sky-800 */
      --ring:#38bdf8;     /* sky-400 */
      --line:#e5e7eb;     /* gray-200 */
    }
    html,body{height:100%;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;}
    .container{max-width:980px;margin:34px auto;padding:20px;}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:22px;box-shadow:0 6px 24px rgba(2,6,23,.08);}    
    h1{font-size:clamp(20px,3.2vw,30px);margin:0 0 8px}
    p.sub{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr)}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    @media (max-width:860px){.col-4,.col-6{grid-column:span 12}}
    label{display:block;font-size:14px;color:var(--muted);margin:0 0 6px}
    input[type="number"], input[type="text"]{padding:12px 10px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);outline:none;transition:border-color .15s, box-shadow .15s}
    input[type="number"]:focus, input[type="text"]:focus{border-color:var(--ring);box-shadow:0 0 0 3px rgba(56,189,248,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#f8fafc;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:var(--ring)}
    .btn.secondary{background:#fff}
    .checkbox{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:12px;background:#fff;border:1px solid var(--line);flex-wrap:wrap}
    .checkbox input[type="checkbox"]{width:18px;height:18px}
    .muted{color:var(--muted)}
    .result{display:flex;flex-direction:column;gap:8px;border:1px solid var(--line);background:#ffffff;padding:18px;border-radius:16px}
    .result .value{font-size:clamp(28px,4.2vw,40px);font-weight:800}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#e0f2fe;border:1px solid #bae6fd;color:#075985;font-size:12px}
    .footer{margin-top:14px;color:var(--muted);font-size:12px}
    .section-title{margin:8px 0 6px;font-weight:800}
    .multiplier-list{display:grid;gap:10px}

    /* 入力の横幅調整 */
    .short{width:220px;max-width:100%}

    /* 追加倍率の入力が隠れないように広げる */
    .flex-grow{flex:1 1 320px;min-width:260px}
    .fix-width{width:140px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ダメージ計算ツール</h1>
      <p class="sub">攻撃力と加撃量を入力し、必要な倍率にチェックを入れてください。結果は自動計算されます。</p>

      <div class="grid" role="group" aria-label="入力エリア">
        <div class="col-6">
          <label for="atk">攻撃力</label>
          <input id="atk" class="short" type="number" min="0" step="1" placeholder="例: 30000" />
        </div>
        <div class="col-6">
          <label for="plus">加撃量</label>
          <input id="plus" class="short" type="number" min="0" step="1" placeholder="例: 3000" />
        </div>
      </div>

      <hr style="border: none; border-top:1px solid var(--line); margin:18px 0;" />

      <!-- カテゴリ別倍率 -->
      <div class="grid" role="group" aria-label="倍率エリア">
        <div class="col-12">
          <!-- キャラ倍率 -->
          <div class="section-title">キャラ倍率</div>
          <div id="charBuiltin" class="multiplier-list"></div>
          <div id="charUser" class="multiplier-list"></div>
          <div class="row" style="margin-top:8px">
            <input id="charNewName" class="flex-grow" type="text" />
            <input id="charNewValue" class="fix-width" type="number" step="0.01"/>
            <button class="btn" id="charAdd">追加</button>
          </div>

          <hr style="border: none; border-top:1px solid var(--line); margin:18px 0;" />

          <!-- 敵の倍率 -->
          <div class="section-title">敵の倍率</div>
          <div id="enemyBuiltin" class="multiplier-list"></div>
          <div id="enemyUser" class="multiplier-list"></div>
          <div class="row" style="margin-top:8px">
            <input id="enemyNewName" class="flex-grow" type="text" placeholder="例: 属性耐性ダウン" />
            <input id="enemyNewValue" class="fix-width" type="number" step="0.01" placeholder="例: 1.25" />
            <button class="btn" id="enemyAdd">追加</button>
          </div>

          <hr style="border: none; border-top:1px solid var(--line); margin:18px 0;" />

          <!-- ステージ倍率 -->
          <div class="section-title">ステージ倍率</div>
          <div id="stageBuiltin" class="multiplier-list"></div>
          <div id="stageUser" class="multiplier-list"></div>
          <div class="row" style="margin-top:8px">
            <input id="stageNewName" class="flex-grow" type="text" placeholder="例: パネル効果" />
            <input id="stageNewValue" class="fix-width" type="number" step="0.01" placeholder="例: 1.50" />
            <button class="btn" id="stageAdd">追加</button>
            <button class="btn secondary" id="resetBtn" title="初期状態へ">初期化</button>
          </div>
        </div>
      </div>

      <hr style="border: none; border-top:1px solid var(--line); margin:18px 0;" />

      <div class="grid" role="group" aria-label="結果表示">
        <div class="col-12 result">
          <div><span class="pill">計算結果</span></div>
          <div class="value" id="total">0</div>
          <div class="mono muted" id="formula">= (0 + 0) × 1.00 （倍率なし）</div>
        </div>
      </div>

      <div class="footer">ブラウザだけで動作。入力や倍率は自動保存（ローカルストレージ）されます。</div>
    </div>
  </div>

  <script>
    // ---- 永続化 ----
    const store = {
      load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } },
      save(key, value){ try{ localStorage.setItem(key, JSON.stringify(value)) }catch{} }
    }

    // ---- 状態 ----
    const state = {
      atk: 0,
      plus: 0,
      char: {
        builtins: [ 
          { id: crypto.randomUUID(), name: 'ゲージ', value: 1.20, checked: false, editable: false },
          { id: crypto.randomUUID(), name: 'キラー', value: 1.50, checked: false, editable: true },
          { id: crypto.randomUUID(), name: '超ADW', value: 1.30, checked: false, editable: false },
          { id: crypto.randomUUID(), name: '超AW', value: 1.30, checked: false, editable: true },
          { id: crypto.randomUUID(), name: '剣', value: 1.50, checked: false, editable: false },
          { id: crypto.randomUUID(), name: '守護獣', value: 1.20, checked: false, editable: true },
  　　　　　{ id: crypto.randomUUID(), name: '紋章', value: 1.375, checked: false, editable: true } 
        ],
        user: []
      },
      enemy: {
        builtins: [ 
          { id: crypto.randomUUID(), name: '直殴り倍率', value: 2.0, checked: false, editable: true },
          { id: crypto.randomUUID(), name: '弱点倍率', value: 3.0, checked: false, editable: true },
        　 { id: crypto.randomUUID(), name: '防御ダウン倍率', value: 3.0, checked: false, editable: true }
        ],
        user: []
      },
      stage: {
        builtins: [
 　       { id: crypto.randomUUID(), name: '属性倍率', value: 2.0, checked: false, editable: true }
          
        ],
        user: []
      }
    }

    // ---- 要素参照 ----
    const $atk = document.getElementById('atk')
    const $plus = document.getElementById('plus')

    const el = {
      charBuiltin: document.getElementById('charBuiltin'),
      charUser: document.getElementById('charUser'),
      charNewName: document.getElementById('charNewName'),
      charNewValue: document.getElementById('charNewValue'),
      charAdd: document.getElementById('charAdd'),

      enemyBuiltin: document.getElementById('enemyBuiltin'),
      enemyUser: document.getElementById('enemyUser'),
      enemyNewName: document.getElementById('enemyNewName'),
      enemyNewValue: document.getElementById('enemyNewValue'),
      enemyAdd: document.getElementById('enemyAdd'),

      stageBuiltin: document.getElementById('stageBuiltin'),
      stageUser: document.getElementById('stageUser'),
      stageNewName: document.getElementById('stageNewName'),
      stageNewValue: document.getElementById('stageNewValue'),
      stageAdd: document.getElementById('stageAdd')
    }

    const $total = document.getElementById('total')
    const $formula = document.getElementById('formula')
    const $resetBtn = document.getElementById('resetBtn')

    function init(){
      const saved = store.load('damage-calc-v4', null)
      if(saved){
        state.atk = Number(saved.atk)||0
        state.plus = Number(saved.plus)||0
        ;['char','enemy','stage'].forEach(cat=>{
          const cur = state[cat]
          const sv = saved[cat]||{}
          cur.builtins = cur.builtins.map(b=>{
            const found = (sv.builtins||[]).find(x=>x.name===b.name)
            const editable = !!b.editable
            return found ? { ...b, checked: !!found.checked, value: editable ? Number(found.value)||b.value : b.value } : b
          })
          cur.user = Array.isArray(sv.user) ? sv.user : []
        })
      }

      $atk.value = state.atk
      $plus.value = state.plus

      renderAll()
      update()
    }

    function persist(){ store.save('damage-calc-v4', state) }

    // ---- 共通UI ----
    function product(arr){ return arr.reduce((acc, m)=> acc * (m.checked ? Number(m.value)||1 : 1), 1) }

    function renderBuiltin(container, list){
      container.innerHTML = ''
      list.forEach(m=>{
        const row = document.createElement('div')
        row.className = 'checkbox row'

        const cb = document.createElement('input')
        cb.type = 'checkbox'
        cb.checked = !!m.checked
        cb.addEventListener('change', ()=>{ m.checked = cb.checked; update() })

        const label = document.createElement('div')
        label.style.fontWeight = '600'

        if(m.editable){
          label.textContent = `${m.name} × `
          const valInput = document.createElement('input')
          valInput.type = 'number'
          valInput.step = '0.01'
          valInput.value = m.value
          valInput.className = 'fix-width'
          valInput.addEventListener('input', ()=>{
            const v = Number(valInput.value)
            m.value = (Number.isFinite(v) && v>0) ? v : 1
            update()
          })
          row.append(cb, label, valInput)
        }else{
          label.textContent = `${m.name} × ${Number(m.value).toFixed(2)}`
          row.append(cb, label)
        }

        container.appendChild(row)
      })
    }

    function renderUser(container, list){
      container.innerHTML = ''
      list.forEach((m)=>{
        const row = document.createElement('div')
        row.className = 'checkbox row'

        const cb = document.createElement('input')
        cb.type = 'checkbox'
        cb.checked = !!m.checked
        cb.addEventListener('change', ()=>{ m.checked = cb.checked; update() })

        const nameInput = document.createElement('input')
        nameInput.type = 'text'
        nameInput.value = m.name
        nameInput.className = 'flex-grow'
        nameInput.addEventListener('input', ()=>{ m.name = nameInput.value; persist(); refreshFormulaOnly() })

        const multMark = document.createElement('span')
        multMark.textContent = '×'
        multMark.style.opacity = .7

        const valInput = document.createElement('input')
        valInput.type = 'number'
        valInput.step = '0.01'
        valInput.value = m.value
        valInput.className = 'fix-width'
        valInput.addEventListener('input', ()=>{ 
          const v = Number(valInput.value)
          m.value = (Number.isFinite(v) && v>0) ? v : 1
          update()
        })

        const del = document.createElement('button')
        del.className = 'btn secondary'
        del.textContent = '削除'
        del.addEventListener('click', ()=>{ list.splice(list.indexOf(m),1); renderAll(); update() })

        row.append(cb, nameInput, multMark, valInput, del)
        container.appendChild(row)
      })
    }

    function renderAll(){
      renderBuiltin(el.charBuiltin, state.char.builtins)
      renderUser(el.charUser, state.char.user)

      renderBuiltin(el.enemyBuiltin, state.enemy.builtins)
      renderUser(el.enemyUser, state.enemy.user)

      renderBuiltin(el.stageBuiltin, state.stage.builtins)
      renderUser(el.stageUser, state.stage.user)
    }

    // ---- 追加ボタン ----
    el.charAdd.addEventListener('click', ()=> addUser(state.char, el.charNewName, el.charNewValue))
    el.enemyAdd.addEventListener('click', ()=> addUser(state.enemy, el.enemyNewName, el.enemyNewValue))
    el.stageAdd.addEventListener('click', ()=> addUser(state.stage, el.stageNewName, el.stageNewValue))

    function addUser(cat, $name, $val){
      const name = ($name.value||'倍率').trim()
      const val = Number($val.value)
      if(!Number.isFinite(val) || val<=0){
        alert('倍率は 0 より大きい数値で入力してください（例: 1.20）')
        return
      }
      cat.user.push({ id: crypto.randomUUID(), name, value: val, checked: true })
      $name.value = ''
      $val.value = ''
      renderAll(); update()
    }

    // ---- 計算 ----
    function update(){
      const atk = Number($atk.value)||0
      const plus = Number($plus.value)||0
      state.atk = atk
      state.plus = plus

      const base = atk + plus
      const lists = [state.char,state.enemy,state.stage]
      const selected = lists.map(x=>[...x.builtins,...x.user]).flat()
      const mult = selected.reduce((acc,m)=> acc * (m.checked ? Number(m.value)||1 : 1), 1)
      const total = base * mult

      $total.textContent = Number.isFinite(total) ? Math.round(total).toLocaleString() : '0'

      const checked = selected.filter(m=>m.checked)
      const multText = checked.length ? checked.map(m=>`${m.name}×${Number(m.value).toFixed(2)}`).join(' × ') : '倍率なし'
      const multProd = checked.length ? checked.reduce((acc,m)=> acc * Number(m.value), 1) : 1
      $formula.textContent = `= (${atk.toLocaleString()} + ${plus.toLocaleString()}) × ${multProd.toFixed(2)} （${multText}）`

      persist()
    }

    function refreshFormulaOnly(){
      const atk = Number(state.atk)||0
      const plus = Number(state.plus)||0
      const base = atk + plus
      const lists = [state.char,state.enemy,state.stage]
      const checked = lists.map(x=>[...x.builtins,...x.user]).flat().filter(m=>m.checked)
      const multText = checked.length ? checked.map(m=>`${m.name}×${Number(m.value).toFixed(2)}`).join(' × ') : '倍率なし'
      const multProd = checked.length ? checked.reduce((acc,m)=> acc * Number(m.value), 1) : 1
      $formula.textContent = `= (${atk.toLocaleString()} + ${plus.toLocaleString()}) × ${multProd.toFixed(2)} （${multText}）`
    }

    // 初期化
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(!confirm('倍率リストを初期状態に戻しますか？\n)) return
      state.char = { builtins: [ 
        { id: crypto.randomUUID(), name: 'ゲージ', value: 1.20, checked: false, editable: false } ,
        { id: crypto.randomUUID(), name: 'キラー', value: 1.50, checked: false, editable: true },
        { id: crypto.randomUUID(), name: '超ADW', value: 1.30, checked: false, editable: false },
        { id: crypto.randomUUID(), name: '超AW', value: 1.30, checked: false, editable: true },
       { id: crypto.randomUUID(), name: '剣', value: 1.50, checked: false, editable: false },
         { id: crypto.randomUUID(), name: '守護獣', value: 1.20, checked: false, editable: true },
  　　　　　{ id: crypto.randomUUID(), name: '紋章', value: 1.375, checked: false, editable: true }
      ], user: [] }
      state.enemy = { builtins: [
        { id: crypto.randomUUID(), name: '弱点倍率', value: 3.00, checked: false, editable: true }, 
       { id: crypto.randomUUID(), name: '弱点倍率', value: 3.0, checked: false, editable: true },
      { id: crypto.randomUUID(), name: '防御ダウン倍率', value: 3.0, checked: false, editable: true }
      ], user: [] }
      state.stage = { builtins: [], user: [] }
      renderAll(); update()
    })

    // 入力イベント
    $atk.addEventListener('input', update)
    $plus.addEventListener('input', update)

    // 起動
    init()
  </script>
</body>
</html>
